generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  READER
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String?
  image     String?
  role      Role      @default(READER)
  createdAt DateTime  @default(now())

  posts     Post[]
  sessions  Session[]
  comments  Comment[]
  images    Image[]
}

model Post {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  excerpt     String
  content     String    @db.Text
  coverImage  String?
  published   Boolean   @default(false)
  publishedAt DateTime?
  readTime    String
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  author      User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories  Category[] @relation("PostCategories")
  pageViews   PageView[]
  comments    Comment[]

  @@index([slug])
  @@index([published, publishedAt])
}

model Category {
  id    String @id @default(cuid())
  name  String @unique
  slug  String @unique

  posts Post[] @relation("PostCategories")

  @@index([slug])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PageView {
  id          String   @id @default(cuid())
  postId      String
  viewedAt    DateTime @default(now())
  userAgent   String?
  ipHash      String?
  readingTime Int?

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, viewedAt])
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  postId    String
  userId    String
  createdAt DateTime @default(now())
  approved  Boolean  @default(false)

  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [userId], references: [id])

  @@index([postId, approved])
}

model Image {
  id          String   @id @default(cuid())
  filename    String
  url         String
  alt         String?
  uploadedBy  String
  createdAt   DateTime @default(now())

  uploader User @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@index([uploadedBy, createdAt])
}
